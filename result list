<?php include 'db_connect.php'; ?>
<div class="card card-outline card-primary">
  <div class="card-header">
    <h3 class="card-title">Results List</h3>
    <div class="card-tools">
      <a href="result_add.php" class="btn btn-primary btn-sm">+ Add Result</a>
    </div>
  </div>
  <div class="card-body">
    <table class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>#</th>
          <th>Student</th>
          <th>Course</th>
          <th>Subjects</th>
          <th>Average (%)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <?php
        $i=1;
        $qry = $conn->query("SELECT r.*, CONCAT(s.firstname,' ',s.lastname) as student, c.course_name 
                              FROM results r 
                              JOIN students s ON r.student_id = s.id 
                              JOIN courses c ON r.course_id = c.id 
                              ORDER BY r.date_created DESC");
        while($row = $qry->fetch_assoc()):
          $subs = $conn->query("SELECT COUNT(*) as cnt FROM result_items WHERE result_id=".$row['id'])->fetch_assoc()['cnt'];
        ?>
        <tr>
          <td><?= $i++ ?></td>
          <td><?= $row['student'] ?></td>
          <td><?= $row['course_name'] ?></td>
          <td><?= $subs ?></td>
          <td><?= $row['marks_percentage'] ?>%</td>
          <td>
            <a href="view_result.php?id=<?= $row['id'] ?>" class="btn btn-info btn-sm">View</a>
          </td>
        </tr>
        <?php endwhile; ?>
      </tbody>
    </table>
  </div>
</div>
